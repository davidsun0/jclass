(in-package #:jclass)

(defmacro with-gensyms (symbols &body body)
  `(let ,(loop for s in symbols collect `(,s (gensym)))
     ,@body))

(defun flatten (tree)
  "Flattens a tree into a list of leaves. Treats nil as an empty list, not an atom."
  (let ((output '()))
    (labels ((traverse (tree)
	       (cond
		 ((null tree)) ;; ignore nil
		 ((atom tree) (push tree output))
		 (t (map nil #'traverse tree)))))
      (traverse tree)
      (nreverse output))))

(eval-when (:compile-toplevel :load-toplevel :execute)
  (defun symbol-concatenate (&rest values)
    (intern (format nil "窿鲠祯弩┅┅换拈筢篌屙忪ㄤ彐轭瀛泔钿轸轱沆狍蟓骘蝽狒弪蝻ㄥ蝌矧è礤篌徵洪铋翎蜱喉弩筢珏横沣弩箫礤篌徵濠ê蝈痫螋灬礅溽ㄣ镱溟糸镱篝蝈犴ㄦ矧磲篝蝈犴立礤篌徵泔钿轸轱瞟┅┅换迈骀弪翳狒蝈痱弩孱趔翳屐屙孱趔镦狎蜥篝狎糸铉狒轭溴犷孱溟铉换狒狎蜥骈祆痫轭翦虍ㄤ彐篝蝓泗沆狍蟓怡翦狎蜥轭溴换蛮翦磲铋瘐灬糸镱ㄤ彐躅醣瞟⑻轶趔翳怡翦镦怡翦轭翦珏虍扉篝祜玑钿ｘ破瞟┅ㄤ彐躅醪瞟⑻轶趔翳怡翦镦怡翦轭翦珏轭忾孱溟犷扉篝祜玑钿ｘ破ㄡ箬俯祜玑钿ｘ破瞟┅ㄤ彐躅醮瞟⑻轶趔翳怡翦镦怡翦轭翦珏轭忾孱溟犷扉篝祜玑钿ｘ破ㄡ箬泊┅祜玑钿ｘ破ㄡ箬倍┅祜玑钿ｘ破ㄡ箬俯祜玑钿ｘ破瞟┅ㄤ彐躅疳蝮瀛怡翦ㄣ秕铘怡翦螬鏖翳箪雉ㄡ蝌狴轭溴怡翦ㄩō戾铉翳狎蜥轭溴泔躅舂ㄥ蝌矧с灬篌骘蝽狒弪蝻喉弩筢珏⒄铄疱泗邃孱镦怡翦篝蝈犴痱镧磲脲狎蜥泔躅轰轶痨徙邃麸狎蜥轰轶痨徙邃轭溴镦骟弭轭溴哄戾礤铘豉疱ㄡ蝌狴屐屙孱舡豉疱狎蜥烘殪飙痫轭翦泔躅舂ㄩ钽轭溴泔躅舂┅┅ㄤ邈灬轫ㄩ铎轭疳蝮瀛醣疳蝮瀛醪疳蝮瀛醮┅ㄤ彐躅疳蝮瀛醣ㄢ翦螬ㄡ蝈疳蝮瀛怡翦怡翦螬癌ㄤ彐躅疳蝮瀛醪ㄢ翦螬戾è醪怡翦疳蝮瀛怡翦怡翦螬┅祜玳矧ㄡ箬ㄡ蝈醪怡翦癌俯ㄡ蝈醪怡翦暴┅ㄤ彐躅疳蝮瀛醮ㄢ翦螬戾è醮怡翦疳蝮瀛怡翦怡翦螬┅祜玳矧ㄡ箬ㄡ蝈醮怡翦癌泊ㄡ箬ㄡ蝈醮怡翦暴倍ㄡ箬ㄡ蝈醮怡翦博俯ㄡ蝈醮怡翦畅┅ㄤ邈灬轫ㄩ铎轭箝珙邃箝珙邃倍箝珙邃巢┅ㄤ彐躅箝珙邃ㄢ翦⒚镱鲥螋犷躅箝珙邃怡翦俯麸箝珙邃怡翦俯鏖翳翳筢礤忾趔趄轭绠ㄩ怡翦．ūㄥ痿珐┅ō怡翦．ㄥ痿俯怡翦┅ㄤ彐躅箝珙邃倍箬矧舂⒚镱鲥螋犷躅箝珙邃怡翦倍麸箝珙邃怡翦倍鏖翳翳筢礤忾趔趄轭绠ㄩ箬矧．ūㄥ痿钡┅ō箬矧．ㄥ痿倍┅箬矧舂ㄤ彐躅箝珙邃巢ㄩ铘⒚镱鲥螋犷躅箝珙邃怡翦巢麸箝珙邃怡翦巢鏖翳翳筢礤忾趔趄轭绠ㄩ轭．ūㄥ痿潮┅ō轭．ㄥ痿巢┅轭舂ㄤ彐躅孱泔溴盹溟骈邃豸娓篝蜷铉⑴钽镤弩篝蜷铉狍扉篝镦盹溟骈邃赵骗怡翦螽换渝手羽邈串串孟斡粤卧哒翩高轭骘换郁蜷铉轶孱泔溴轭麸赵骗倍翳孱蝈孱泔溴麸赵骗戾è秕麴豸Ж┅灬忮祗è孱泔溴泔溴痫轭ㄣ镤濠ㄣ镱è泔溴ｘ赴瘐箬泔溴秕麴豸┅è泔溴ｘ赴癌瘐箬祜玳矧ｂ北鞍鞍鞍ㄡ箬泔溴订秕麴豸瘐箬祜玳矧ｂ卑鞍鞍鞍祜玑钿ｘ称泔溴┅秕麴豸┅è泔溴ｘ卑鞍癌瘐箬祜玳矧ｂ北卑鞍鞍ㄡ箬泔溴辈┅秕麴豸瘐箬祜玳矧ｂ卑鞍鞍鞍祜玑钿ｘ称ㄡ箬泔溴订┅秕麴豸瘐箬祜玳矧ｂ卑鞍鞍鞍祜玑钿ｘ称泔溴┅秕麴豸┅è泔溴ｘ北鞍鞍戾舄è泔溴ō泔溴ｘ卑鞍癌换腻泔眇矬轭麸赵骗倍篚蝌镧狒疳轵躔疱ㄡ箬泔溴卑┅祜麇祜玑钿泔溴ｘ称譬┅ㄥ钽镤瀛泔溴痫轭ǐｘ母鞍躔疱颟ㄥ钽镤瀛泔溴痫轭ǐｘ拿鞍祜麇颟┅换身痨屙孱翎糸镱翳狒汜轭驽翳轶轶躅蝈徙栳忪泔溴－矧筲沆ㄥ蝌矧⑸铞犰殇疹殂镤泔溴痫轭艉立泔溴┅┅祜镳骘泔溴徙蝻篌篝蜷铉滹ㄥ钽镤瀛泔溴痫轭ㄣ栳颦泔溴泔溴┅铗弼弪箦秕麴豸┅┅ㄤ彐躅溴泔溴盹溟骈邃豸娓ㄢ翦螬⒛邈镤弩箦聃孱沐镦盹溟骈邃赵骗怡翦轭麸篝蜷铉换渝手羽邈串串孟斡粤卧哒翩高轭骘戾è轭瘐ㄣ镥蜚怡翦ъ轶舂秕麴豸Ж┅灬忮祗è屮趄徙舡忾趔磲箅箬殒怡翦ㄡ篌弪磲箅ㄡ箬怡翦ō箬殒舂┅ㄢ翦с灬篌骘蝽狒弪蝻喉弩筢珏ㄦ矧磲铋⑸铞犰殇赵骗怡翦立怡翦┅祜玑钿ūㄡ箬箬殒舂怡翦┅ㄤ邈镤瀛豸娓ī戾è怡翦痫轭瘐舂┅ㄣ镱è犷弪镳ㄡ箬怡翦珐铒弪镳怡翦┅怡翦èㄡ箬怡翦旦ｂ北癌祜玳矧ㄡ箬ㄥ趄徙舡忾趔ｂ北怡翦订ㄥ趄徙舡忾趔ｂ卑痫轭瘐舂┅èㄡ箬怡翦穿ｂ北卑祜玳矧ㄡ箬ㄥ趄徙舡忾趔ｂ北卑怡翦辈ㄡ箬ㄥ趄徙舡忾趔ｂ卑痫轭瘐舂订ㄥ趄徙舡忾趔ｂ卑痫轭瘐舂┅ㄥ蝌矧с灬篌骘蝽狒弪蝻喉弩筢珏ㄦ矧磲铋⑸铞犰殇盹溟骈邃赵骗箦聃孱沐立怡翦螬┅┅┅祜镳麒殪轭瘐滹瘐箬戾è泔溴痫轭ㄤ邈镤瀛豸娓┅ㄣ镱è矧泔溴痫轭ｘ母鞍冀ｘ虐鞍泔溴痫轭舂ㄣ镤瀛汨狎泔溴痫轭舂è冀ｘ母鞍泔溴痫轭ｘ穆破换溴泔溴赵骗倍篚蝌镧狒疳轵戾è躔疱泔溴痫轭舂祜麇ㄤ邈镤瀛豸娓┅ㄡ篌弪冀ｘ拿鞍祜麇ｘ钠破祜麇颟с灬篌骘蝽狒弪蝻喉弩筢珏ㄦ矧磲铋⑸铞犰殇篚蝌镧狒疳轵立躔疱祜麇颟ㄣ镤瀛汨狎ǐｘ卑鞍祜玳矧ㄡ箬ō躔疱ｘ母鞍卑ō祜麇ｘ拿鞍┅┅┅ㄥ蝌矧с灬篌骘蝽狒弪蝻喉弩筢珏ㄦ矧磲铋⑸铞犰殇盹溟骈邃赵骗箦聃孱沐立怡翦螬┅┅秕麴豸┅ㄣ镥蜚铗弼弪箦秕麴豸篝蜷铉┅┅