(in-package #:jclass)

(defmacro with-gensyms (symbols &body body)
  `(let ,(loop for s in symbols collect `(,s (gensym)))
     ,@body))

(defmacro fresh-dolist ((var list-form) &body body)
  "A simple version of dolist that also guarantees a fresh binding of `var`."
  (with-gensyms (fresh)
  `(loop for ,fresh in ,list-form do
    (let ((,var ,fresh))
      ,@body))))

(defun flatten (tree)
  "Flattens a tree into a list of leaves. Treats nil as an empty list, not an atom."
  (let ((output '()))
    (labels ((traverse (tree)
	       (cond
		 ((null tree)) ; ignore nil
		 ((atom tree) (push tree output))
		 (t (map nil #'traverse tree)))))
      (traverse tree)
      (nreverse output))))

(eval-when (:compile-toplevel :load-toplevel :execute)
  (defun symbol-concatenate (&rest values)
    (intern (format nil "窿鲠祯弩┅┅换蛮翦磲铋瘐灬糸镱ㄤ邈灬轫ㄩ铎轭醣醪醮箝珙邃箝珙邃倍箝珙邃巢┅ㄤ彐躅醣瞟⑻轶趔翳怡翦镦怡翦轭翦珏虍扉篝祜玑钿ｘ破瞟┅ㄤ彐躅醪瞟⑻轶趔翳怡翦镦怡翦轭翦珏轭忾孱溟犷扉篝祜玑钿ｘ破ㄡ箬俯祜玑钿ｘ破瞟┅ㄤ彐躅醮瞟⑻轶趔翳怡翦镦怡翦轭翦珏轭忾孱溟犷扉篝祜玑钿ｘ破ㄡ箬泊┅祜玑钿ｘ破ㄡ箬倍┅祜玑钿ｘ破ㄡ箬俯祜玑钿ｘ破瞟┅ㄤ彐躅箝珙邃ㄢ翦⒂殓屮翦钿犷躅箝珙邃怡翦俯麸箝珙邃怡翦俯祜玳矧怡翦ō磲箅骈屐ㄢ翦珐怡翦┅┅ㄤ彐躅箝珙邃倍箬矧舂⒂殓屮翦钿犷躅箝珙邃怡翦倍麸箝珙邃怡翦倍┊祜玳矧箬矧ō磲箅骈屐ㄢ翦钡箬矧舂┅ㄤ彐躅箝珙邃巢ㄩ铘⒂殓屮翦钿犷躅箝珙邃怡翦巢麸箝珙邃怡翦巢┊祜玳矧轭ō磲箅骈屐ㄢ翦潮轭舂┅换拈筢篌屙忪ㄤ彐轭瀛泔钿轸轱沆狍蟓骘蝽狒弪蝻ㄥ蝌矧è礤篌徵洪铋翎蜱喉弩筢珏横沣弩箫礤篌徵濠ê蝈痫螋灬礅溽ㄣ镱溟糸镱篝蝈犴ㄦ矧磲篝蝈犴立礤篌徵泔钿轸轱瞟┅┅换迈骀弪翳狒蝈痱弩孱趔翳屐屙孱趔镦狎蜥篝狎糸铉狒轭溴犷孱溟铉换狒狎蜥骈祆痫轭翦虍ㄤ彐篝蝓泗沆狍蟓怡翦狎蜥轭溴ㄤ彐躅疳蝮瀛怡翦ㄣ秕铘怡翦螬鏖翳箪雉ㄡ蝌狴轭溴怡翦ㄩō戾铉翳狎蜥轭溴泔躅舂ㄥ蝌矧с灬篌骘蝽狒弪蝻喉弩筢珏⒄铄疱泗邃孱镦怡翦篝蝈犴痱镧磲脲狎蜥泔躅轰轶痨徙邃麸狎蜥轰轶痨徙邃轭溴镦骟弭轭溴哄戾礤铘豉疱ㄡ蝌狴屐屙孱舡豉疱狎蜥烘殪飙痫轭翦泔躅舂ㄩ钽轭溴泔躅舂┅┅ㄤ邈灬轫ㄩ铎轭疳蝮瀛醣疳蝮瀛醪疳蝮瀛醮┅ㄤ彐躅疳蝮瀛醣ㄢ翦螬ㄡ蝈疳蝮瀛怡翦怡翦螬癌ㄤ彐躅疳蝮瀛醪ㄢ翦螬戾è醪怡翦疳蝮瀛怡翦怡翦螬┅祜玳矧ㄡ箬ㄡ蝈醪怡翦癌俯ㄡ蝈醪怡翦暴┅ㄤ彐躅疳蝮瀛醮ㄢ翦螬戾è醮怡翦疳蝮瀛怡翦怡翦螬┅祜玳矧ㄡ箬ㄡ蝈醮怡翦癌泊ㄡ箬ㄡ蝈醮怡翦暴倍ㄡ箬ㄡ蝈醮怡翦博俯ㄡ蝈醮怡翦畅┅ㄤ彐躅孱泔溴盹溟骈邃豸娓篝蜷铉⑴钽镤弩篝蜷铉狍扉篝镦盹溟骈邃赵骗怡翦螽换渝手羽邈串串孟斡粤卧哒翩高轭骘换郁蜷铉轶孱泔溴轭麸赵骗倍翳孱蝈孱泔溴麸赵骗ㄦ戾è豸姹董觉翩ㄣ镤濠ㄣ镱è泔溴ｘ赴扉篝泔溴┅è泔溴ｘ赴癌扉篝ㄤ疴ㄡ箬泔溴订ㄢ翦癌ｂ北鞍鞍鞍ㄤ疴泔溴ㄢ翦癌ｂ卑鞍鞍鞍┅扉篝ㄤ疴ㄡ箬泔溴辈ㄢ翦癌ｂ北卑鞍鞍ㄤ疴ㄡ箬泔溴订ㄢ翦癌ｂ卑鞍鞍鞍ㄤ疴泔溴ㄢ翦癌ｂ卑鞍鞍鞍┅┅┅祜镳骘泔溴轭磲ъ轶＇汨狎泔溴篝蜷铉殒窘泔溴ｘ卑鞍癌换腻泔眇矬轭麸篚蝌镧狒疳轵螽泔祆邈ǐｘ母鞍熹ㄢ翦卑卑ō泔溴ｘ卑鞍癌┅轭麸豸姹犷泔祆邈ǐｘ拿鞍熹ㄢ翦卑癌泔溴┅轭麸豸姹屐箦泔祆邈泔溴轭麸豸姹骈钺祆蝈趱蝾ㄡ痧禊＇狃疱钿磲疸狎＇豸姹董觉翩豸姹订┅┅ㄤ彐躅溴泔溴盹溟骈邃豸娓ㄢ翦螬⑸铘弪痱弭箦聃孱沐镦躅箝珙邃怡翦俯狍盹溟骈邃赵骗篝蜷铉换渝手羽邈串串孟斡粤卧哒翩高轭骘戾è怡翦扉篝ㄣ镥蜚怡翦ъ轶舂┅灬忮祗è屮趄徙舡忾趔戾徜鏖漪轭翦珏箬殒舂ㄡ篌弪ㄡ箬轭翦珏ō鏖漪瑭戾徜ㄩ铘彗弪⒄铄疱泗邃盹溟骈邃赵骗怡翦廉轭翦珏颟ㄡ箬熹ㄢ翦鏖漪癌轭翦珏颟箬殒舂ㄤ邈镤瀛豸娓ī戾è怡翦痫怡翦扉篝┅ㄣ镱è铒矧弪镳怡翦祜玮轸怡翦┅怡翦è熹ㄢ翦旦怡翦ｂ北癌祜玳矧ㄥ趄徙舡忾趔ｂ北怡翦订ㄥ趄徙舡忾趔ｂ卑痫怡翦扉篝癌┅è熹ㄢ翦穿怡翦ｂ北卑祜玳矧ㄥ趄徙舡忾趔ｂ北卑怡翦辈ㄥ趄徙舡忾趔ｂ卑痫怡翦扉篝订ㄥ趄徙舡忾趔ｂ卑痫怡翦扉篝癌┅ㄥ蝌矧⑸铞犰殇盹溟骈邃赵骗箦聃孱沐廉怡翦螬┅┅ㄤ邈镤瀛豸姹ī戾è泔溴ㄤ邈镤瀛豸娓┅ㄣ镱è矧泔溴ｘ母鞍窘泔溴ｘ虐鞍┅泔溴è冀ｘ母鞍泔溴ｘ穆破戾è躔疱泔溴祜麇ㄤ邈镤瀛豸娓┅ㄡ篌弪冀ｘ拿鞍祜麇ｘ钠破祜麇颟⑸铞犰殇赵骗倍篚蝌镧狒疳轵廉躔疱祜麇颟ǐｘ卑鞍祜玳矧ㄥ趄徙舡忾趔ｂ北氨卑卑躔疱卑ㄥ趄徙舡忾趔ｂ北氨北卑祜麇癌┅┅ㄥ蝌矧⑸铞犰殇赵骗倍泔溴痫轭廉泔溴┅┅┅祜镳麒殪怡翦扉篝泔祆邈ㄤ邈镤瀛豸姹订轭麸汨狎骈钺祆蝈趱蝾磲篝蜷铉＇泔溴汨狎汨狎螬┅┅