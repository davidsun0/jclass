(defpackage #:jclass
  (:use :cl))
(in-package #:jclass)

;;; Utility

(defmacro with-gensyms (symbols &body body)
  `(let ,(loop for s in symbols collect `(,s (gensym)))
     ,@body))

(defun flatten (tree &key (remove-nil nil))
  (if remove-nil
      (labels ((flatten-remove (tree)
		 (cond ((null tree) '())
		       ((atom tree) (list tree))
		       (t (loop for subtree in tree
				if (listp subtree)
				  append (flatten-remove subtree)
				else
				  collect subtree)))))
	(flatten-remove tree))
      (labels ((flatten-keep (tree)
		 (if (atom tree)
		     (list tree)
		     (loop for subtree in tree
			   append (flatten-keep subtree)))))
	(flatten-keep tree))))

(eval-when (:compile-toplevel :load-toplevel :execute)
  (defun symbol-concatenate (&rest values)
    (intern (format nil "窿鲠祯弩┅┅换拈筢篌屙忪ㄤ彐轭瀛泔钿轸轱沆狍蟓骘蝽狒弪蝻ㄥ蝌矧è礤篌徵洪铋翎蜱喉弩筢珏横沣弩箫礤篌徵濠ê蝈痫螋灬礅溽ㄣ镱溟糸镱篝蝈犴ㄦ矧磲篝蝈犴立礤篌徵泔钿轸轱瞟┅┅ㄤ彐篝蝓泗沆狍蟓怡翦狎蜥轭溴换蛮翦磲铋瘐灬糸镱ㄤ彐躅醣瞟⑻轶趔翳怡翦镦怡翦轭翦珏虍扉篝祜玑钿ｘ破瞟┅ㄤ彐躅醪瞟⑻轶趔翳怡翦镦怡翦轭翦珏轭忾孱溟犷扉篝祜玑钿ｘ破ㄡ箬俯祜玑钿ｘ破瞟┅ㄤ彐躅醮瞟⑻轶趔翳怡翦镦怡翦轭翦珏轭忾孱溟犷扉篝祜玑钿ｘ破ㄡ箬泊┅祜玑钿ｘ破ㄡ箬倍┅祜玑钿ｘ破ㄡ箬俯祜玑钿ｘ破瞟┅ㄤ彐躅疳蝮瀛怡翦ㄣ秕铘怡翦螬鏖翳箪雉ㄡ蝌狴轭溴怡翦ㄩō戾铉翳狎蜥轭溴泔躅舂ㄥ蝌矧с灬篌骘蝽狒弪蝻喉弩筢珏⒄铄疱泗邃孱镦怡翦篝蝈犴痱镧磲脲狎蜥泔躅轰轶痨徙邃麸狎蜥轰轶痨徙邃轭溴镦骟弭轭溴哄戾礤铘豉疱ㄡ蝌狴屐屙孱舡豉疱狎蜥烘殪飙痫轭翦泔躅舂ㄩ钽轭溴泔躅舂┅┅ㄤ彐躅疳蝮瀛醣ㄢ翦螬ㄡ蝈疳蝮瀛怡翦怡翦螬癌ㄤ彐躅疳蝮瀛醪ㄢ翦螬戾è醪怡翦疳蝮瀛怡翦怡翦螬┅祜玳矧ㄡ箬ㄡ蝈醪怡翦癌俯ㄡ蝈醪怡翦暴┅ㄤ彐躅疳蝮瀛醮ㄢ翦螬戾è醮怡翦疳蝮瀛怡翦怡翦螬┅祜玳矧ㄡ箬ㄡ蝈醮怡翦癌泊ㄡ箬ㄡ蝈醮怡翦暴倍ㄡ箬ㄡ蝈醮怡翦博俯ㄡ蝈醮怡翦畅┅ㄤ彐躅孱泔溴盹溟骈邃豸娓ㄣ栳蜥泗弪⑴钽镤弩汨狎徙翦狍扉篝镦盹溟骈邃赵骗怡翦螽馏篚礤汨狎泔溴蝈趱蝾翳疹殂镤泔溴痫轭舢渝梳鲠珠螋踽歪汨轭箴邈殒殂狒轱串串孟斡粤卧哒翩高轭骘灬忮祗è孱泔溴泔溴痫轭ㄣ镤濠ㄣ镱è泔溴ｘ赴扉篝泔溴┅è泔溴ｘ赴癌扉篝祜玳矧ｂ北鞍鞍鞍ㄡ箬泔溴订祜玳矧ｂ卑鞍鞍鞍祜玑钿ｘ称泔溴┅┅è泔溴ｘ卑鞍癌扉篝祜玳矧ｂ北卑鞍鞍ㄡ箬泔溴辈┅祜玳矧ｂ卑鞍鞍鞍祜玑钿ｘ称ㄡ箬泔溴订┅祜玳矧ｂ卑鞍鞍鞍祜玑钿ｘ称泔溴┅┅戾舄è泔溴ō泔溴ｘ卑鞍癌躔疱ㄡ箬泔溴卑┅祜麇祜玑钿泔溴ｘ称譬┅换孱泔溴狍赵骗倍篚蝌镧狒疳轵ㄣ镱汜翦钺翦ъ轶ㄥ钽镤瀛泔溴痫轭ǐｘ母鞍躔疱颟ㄥ钽镤瀛泔溴痫轭ǐｘ拿鞍祜麇颟┅┅┅ㄥ钽镤瀛泔溴痫轭ㄣ栳颦泔溴汨狎徙翦颟┅ㄤ彐躅溴泔溴盹溟骈邃豸娓ㄢ翦螬戾è轭瘐ㄣ镥蜚怡翦ъ轶舂秕麴豸Ж┅灬忮祗è屮趄徙舡忾趔磲箅箬殒怡翦ㄡ篌弪磲箅ㄡ箬怡翦ō箬殒舂┅ㄢ翦с灬篌骘蝽狒弪蝻喉弩筢珏ㄦ矧磲铋⑸铞犰殇赵骗怡翦立怡翦┅祜玑钿ūㄡ箬箬殒舂怡翦┅ㄤ邈镤瀛豸娓ī戾è怡翦痫轭瘐舂┅ㄣ镱è犷弪镳ㄡ箬怡翦珐铒弪镳怡翦┅怡翦èㄡ箬怡翦旦ｂ北癌祜玳矧ㄡ箬ㄥ趄徙舡忾趔ｂ北怡翦订ㄥ趄徙舡忾趔ｂ卑痫轭瘐舂┅èㄡ箬怡翦穿ｂ北卑祜玳矧ㄡ箬ㄥ趄徙舡忾趔ｂ北卑怡翦辈ㄡ箬ㄥ趄徙舡忾趔ｂ卑痫轭瘐舂订ㄥ趄徙舡忾趔ｂ卑痫轭瘐舂┅ㄥ蝌矧с灬篌骘蝽狒弪蝻喉弩筢珏ㄦ矧磲铋⑸铞犰殇盹溟骈邃赵骗箦聃孱沐立怡翦螬┅┅┅祜镳麒殪轭瘐滹瘐箬戾è泔溴痫轭ㄤ邈镤瀛豸娓┅ㄣ镱è矧泔溴痫轭ｘ母鞍冀ｘ虐鞍泔溴痫轭舂ㄣ镤瀛汨狎泔溴痫轭舂è冀ｘ母鞍泔溴痫轭ｘ穆破换溴泔溴赵骗倍篚蝌镧狒疳轵戾è躔疱泔溴痫轭舂祜麇ㄤ邈镤瀛豸娓┅ㄡ篌弪冀ｘ拿鞍祜麇ｘ钠破祜麇颟с灬篌骘蝽狒弪蝻喉弩筢珏ㄦ矧磲铋⑸铞犰殇篚蝌镧狒疳轵立躔疱祜麇颟ㄣ镤瀛汨狎ǐｘ卑鞍祜玳矧ㄡ箬ō躔疱ｘ母鞍卑ō祜麇ｘ拿鞍┅┅┅ㄥ蝌矧с灬篌骘蝽狒弪蝻喉弩筢珏ㄦ矧磲铋⑸铞犰殇盹溟骈邃赵骗箦聃孱沐立怡翦螬┅┅秕麴豸┅ㄣ镥蜚铗弼弪箦秕麴豸篝蜷铉┅┅换渝沆狍蟓盹溟骈弪螵礤翳镤盹溟骈弪螵骈屐洵盹溟骈弪螵弭惝ㄤ彐躅徙沐篌盹溟骈弪盹溟骈弪翎忪濠戾è骒徵磲疸狎灬礅溽箦泔钿ㄡ篌镢翎忪濠┅盹溟骈弪螬┅蝈漉沐＇祜玳矧骒徵螬┅ㄤ彐躅徙沐篌骒徵祜镫躔ㄦ灬珞翎忪濠祜镳骘盹溟骈弪轭翎忪麒孱铒弪镳祜玑钿箦泔钿盹溟骈弪骒徵螬┅泔祆邈ㄦ轵篝盹溟骈弪┅换蔑铙翎铘酗镬ㄤ彐篝蝓泗泔铙翎铘痫镬箝癌换磲痧轭骝镯泔铙翎铘麸痫镬轭溴翎忪磲脲栳箬翎忪呼弩у聃犰┅ㄤ彐珏铄蜷蝈箫祧瀛泔铙翎铘痫镬泔铙翎铘豉疱蝈篝溽翎ê滹沲礤铘狒轱⒁邈躜箝鲥禊徜潴泔铙翎铘篝蝓泗溴疱钿孱汩弩麸泔铙翎铘痫镬┅ㄤ彐珏铄蜷泔铙翎铘轭骘怡翦痫镬泔铙翎铘豉疱蝈篝溽翎ê滹沲礤铘狒轱⒚镱鲥螋泔铙翎铘篝蝓泗麸扉篝镦怡翦螽┅ㄤ彐躅痫镬轭溴痫镬泔铙翎铘镳糸镱犰ㄩ铙弪舂⑸铙弪趔泔铙翎铘轭麸泔铙翎铘痫镬戾è轭溴ㄧ弭栳箬泔铙翎铘ㄣ镱篝犷舡痫镬翎忪痫镬┅┅ㄣ镱换镳糸镱犰泔铙翎铘躞麸蝈痱弩孱铒泔铙翎铘è铛祆泔铙翎铘癌ㄩ钿屮ㄩ铙弪换遽汨泔铙翎铘磲痼麸轸轭溴轭翳痫镬箦翩ㄧ弭栳箬泔铙翎铘ㄣ镱篝犷舡痫镬翎忪痫镬┅ㄩ钽ㄣ镱篝犷舡痫镬箝痫镬换怡翦泔铙翎铘翎脲赭箪雉ㄩ矧ㄥㄦ轵篝泔铙翎铘ъ镱绛轭骘ㄥㄦ轵篝泔铙翎铘т秕忪瀛轭骘┅暴┅ㄥ蝌矧⒚镱篝犷滹弩铒屮轶轭翳痫镬泔铙翎铘┅┅ㄤ彐躅泔铙翎铘痫镬怡翦痫镬⒚镱鲥螋泔铙翎铘痫镬麸铄篝邃扉篝镦怡翦螽换蝈箫祧犰泔铙翎铘戾è痫镬翎忪ㄣ镱篝犷舡痫镬翎忪痫镬┅换滹瞌盹溟纟翳栳箬翎忪麒殪轸弪狒轭秭弪轸祜镳骘脲轭祜镳骘忮轭翳栳箬脲镦痫镬翎忪泔祆邈氅滹ㄡ痧禊＇蝈箫祧瀛泔铙翎铘痫镬脲┅换箫螋泔铙翎铘怡轭溴戾舄è轭溴泔铙翎铘祜镳骘忮轭翳栳箬脲镦痫镬翎忪躞轭ㄨ狍璀鲠祯雯泔祆邈ㄣ镱氅┅箫螋邃泔铙翎铘箫螋轭溴泔铙翎铘＇弘妁＇汜颟痫镬轸屙磲疸狎＇沅箫螋邃泔铙翎铘螬┅换泔铞弪麸怡翦蠡戾铉翳轶鲍徙趱犰铛礅弪镦泔铙翎铘扉篝醪ūㄣ镱篝犷舡痫镬箝痫镬┅祜镳骘轭痫镬轸屙泔祆邈ㄡ痧禊＇泔铙翎铘轭骘怡翦痫镬皓┅┅ㄤ彐磲泸溴姝赉镱篝犷钺礤翎箪雉怙澌怙澌鏖翳珏铙眢痫镬泔铙舡豉疱啜痱镧换遽汨篝蝓泗轶扉篝鏖翳翳泔铙翎铘豉疱狍翳骈蝮鲠祯换翳轶轶箫泔铙翎铘汜忮痫螋徕禊躞邃狍栳箬翎忪脲ㄤ彐篝蝓泗ì钺礤ê豉疱扉篝侯犴邃ê泔铙趄蹉麸簌礅镬泔钽狒孱狒⑼了怒钺礤箪雉螬荔祜趔换蝈箫祧泔铙翎铘箴邈獒扉弩镱翳泔铙翎铘豉疱换鲩ㄡ痧禊痫镬＇蝈箫祧瀛泔铙翎铘泔铙翎铘篝蝓泗ㄤ彐礤翳镤蝈箫祧瀛泔铙翎铘ì痫镬ì泔铙舡豉疱ㄥ耢К钺礤┅蝈篝溽翎痫镬轭溴痫镬ㄣ镱К钺礤溽翎┅换祜汜祆溴骈铄醪痫镬轭溴麸蝈箫祧溴疱钿孱汩弩ㄦ戾è醪痫镬轭溴ㄣ镱篝ㄡ痧禊＇蝈箫祧瀛泔铙翎铘痫镬泔铙舂┅ㄤ邈灬蝈ㄩ珙矧徕戾ㄦ躅泗轱醪痫镬轭溴┅ㄤ弩趄蹉趱蜷铉忾钿箪雉溽翎ㄤ邈灬蝈ㄩ珙矧徕戾荔祜趔┅棱镤┅ㄤ彐礤翳镤泔铙翎铘轭骘怡翦ì痫镬ì泔铙舡豉疱ㄥ耢К钺礤┅蝈篝溽翎换祜汜祆溴骈铄醪痫镬轭溴麸珏翳溴疱钿孱泫轭溴ㄦ戾è醪痫镬轭溴ㄣ镱篝醪痫镬轭溴痫镬泔铙铋飑┅ㄤ邈灬蝈ㄩ珙矧徕戾ㄦ躅泗轱醪痫镬轭溴┅ㄤ弩趄蹉趱蜷铉忾钿箪雉溽翎扉篝翎棱镤┅┅┅ㄤ彐赉镱篝犷豸娓轭骘翦舂戾è翦舡怡翦ㄦ灬趑孱磲ъ轶＇孱泔溴盹溟骈邃豸娓翦舂┅扉篝醪戾铉翳翦舡怡翦螬翦舡怡翦螬┅ㄤ彐赉镱篝犷轭翦珏颦轭骘鲠祯濠醮鲠祯濠ㄤ彐赉镱篝犷骒镝舡轭骘ㄩ邋瀛忾趔醮殄邋忾趔┅换痫镬轭溴犷疳蝮瀛泔铙翎铘痫镬轫痨屙孱翳驷泗翳狒换祜铉轭骘犷滹踱戾轭骘翎脲赭痫镬箪雉ㄤ彐赉镱篝犷祜铉轭骘鲠祯濠醮ㄡ箬鲠祯巢┅醮鲠祯濠ㄤ彐赉镱篝犷滹踱戾轭骘ㄩ邋瀛忾趔醮ㄡ箬殄邋忾趔巢┅醮殄邋忾趔┅ㄤ彐赉镱篝犷沆狍蟓轭骘钺礤醪痫镬轭溴磲脲豸娓轭骘钺礤┅ㄤ彐赉镱篝犷篝蜷铉轭骘翦舂醪痫镬轭溴磲脲豸娓轭骘翦舂┅ㄤ彐赉镱篝犷骈屐洵蝈姝轭骘ㄣ灬篌钺礤钺礤豉疱醪痫镬轭溴磲脲沆狍蟓轭骘沆狍蟓钺礤┅醪痫镬轭溴磲脲钺礤犷洵豉疱轭骘钺礤豉疱┅ㄤ彐赉镱篝犷礤翳镤蝈姝轭骘卑ㄣ灬篌钺礤钺礤豉疱醪痫镬轭溴磲脲沆狍蟓轭骘沆狍蟓钺礤┅醪痫镬轭溴磲脲钺礤犷洵豉疱轭骘钺礤豉疱┅ㄤ彐赉镱篝犷轭翦蜴徙瀛礤翳镤蝈姝轭骘北ㄣ灬篌钺礤钺礤豉疱醪痫镬轭溴磲脲沆狍蟓轭骘沆狍蟓钺礤┅醪痫镬轭溴磲脲钺礤犷洵豉疱轭骘钺礤豉疱┅ㄤ彐赉镱篝犷钺礤犷洵豉疱轭骘辈钺礤豉疱醪痫镬轭溴磲脲豸娓轭骘钺礤┅醪痫镬轭溴磲脲豸娓轭骘豉疱┅ㄤ彐赉镱篝犷礤翳镤栳钿戾轭骘钡腴钿蝈驽蝈钽濠醣腴钿醪痫镬轭溴蝈驽蝈钽濠ㄤ彐赉镱篝犷礤翳镤豉疱轭骘倍ㄤ弩泸轲麸颟醪痫镬轭溴磲脲豸娓轭骘溴筱蜷痿矧┅ㄤ彐赉镱篝犷澌钺黹悱轭骘狈ㄢ镲趔趄狃轭溴钺礤豉疱醪怙雉篝蜥瓠轭溴醪痫镬轭溴磲脲钺礤犷洵豉疱轭骘钺礤豉疱┅ㄤ彐赉镱篝犷轭鲲脲澌钺黹悱轭骘备ㄢ镲趔趄狃轭溴钺礤豉疱醪怙雉篝蜥瓠轭溴醪痫镬轭溴磲脲钺礤犷洵豉疱轭骘钺礤豉疱┅ㄤ彐赉镱篝犷盹漉戾轭骘惫钺礤醪痫镬轭溴磲脲豸娓轭骘钺礤┅ㄤ彐赉镱篝犷疳汶徵瀛轭骘舶钺礤醪痫镬轭溴磲脲豸娓轭骘钺礤┅换蔑铙翎铘痫镬溟筢篌屙忪ㄤ彐躅犰祜汜翦泔铙翎铘ㄢ翦螬换骈蝮疳篌秭弪泔铙翎铘痫镬箴扉轭麸孱趄殄戾è翎疳蝮瀛醣怡翦螬┅ㄣ镱翎ㄣ狍翎è暴戾è戾铉翳疳蝮瀛醪怡翦螬┅扉篝疳蝮瀛怡翦戾铉翳怡翦螬┅è穿扉篝疳蝮瀛醮怡翦螬┅è订扉篝祜玳矧ㄡ箬疳蝮瀛醮怡翦螬巢疳蝮瀛醮怡翦螬┅è倍惫舶扉篝疳蝮瀛醪怡翦螬┅è卑北辈狈备扉篝疳蝮瀛醪怡翦螬疳蝮瀛醪怡翦螬┅è钡扉篝疳蝮瀛醣怡翦螬疳蝮瀛醪怡翦螬┅ㄥ蝌矧с灬篌骘蝽狒弪蝻喉弩筢珏ㄦ矧磲铋⒄铍铒黝翎轭泔铙翎铘痫镬翎绌┅┅┅ㄤ彐躅怩殪洵泔铙翎铘痫镬轭溴换箦泔钿疳篌秭弪泔铙翎铘痫镬怩殪泔铙翎铘犷蝈箫祧溴疱钿孱汩弩戾舄è泔铙翎铘ㄡ蝈痫镬轭溴┅翎ㄦ轵篝泔铙翎铘┅ㄩ簌礅镬翎绌犰蝈徜怩殪泔铙翎铘忮玳鏖翳簌礅镬泔铙翎铘箦翩ㄡ蝈痫镬轭溴ㄣ狍翎è暴磲脲豸娓轭骘ㄤ邈镤瀛盹溟骈邃豸娓箦泔钿泔铙翎铘┅┅è畅磲脲轭翦珏颦轭骘箦泔钿泔铙翎铘┅è穿磲脲骒镝舡轭骘箦泔钿泔铙翎铘┅è订ㄤ弩趄蹉趱蜷铉忾钿ㄨ殓璀怡翦祜鳝怡翦螬蝈篝泔铙翎铘戾è鲠祯祜玳矧ㄡ箬栝玷怡翦巢祜鳝怡翦螬┅ㄩ翎旦磲脲祜铉轭骘鲠祯濠磲脲滹踱戾轭骘鲠祯濠┅┅è倍惫舶戾舄è豸娓轭溴箦泔钿泔铙翎铘┅豸娓泔铙翎铘ㄢ蹰熹泔铙翎铘痫镬豸娓轭溴┅翦豸娓轭骘翦豸娓泔铙翎铘┅ㄣ狍翎è珐磲脲沆狍蟓轭骘翦舂è俯磲脲篝蜷铉轭骘翦舂è倍磲脲礤翳镤豉疱轭骘翦舂è惫磲脲盹漉戾轭骘翦舂è舶磲脲疳汶徵瀛轭骘翦舂┅┅è卑北ㄤ弩趄蹉趱蜷铉忾钿ㄣ灬篌轭溴钺礤豉疱轭溴蝈篝泔铙翎铘戾舄è沆狍蟓泔铙翎铘ㄢ蹰熹泔铙翎铘痫镬沆狍蟓轭溴┅ㄣ灬篌钺礤ㄣ灬篌轭骘钺礤沆狍蟓泔铙翎铘┅钺礤豉疱ㄢ蹰熹泔铙翎铘痫镬钺礤豉疱轭溴┅钺礤钺礤犷洵豉疱轭骘钺礤钺礤豉疱┅豉疱钺礤犷洵豉疱轭骘豉疱钺礤豉疱┅ㄣ狍翎è供磲脲骈屐洵蝈姝轭骘沆狍蟓钺礤钺礤豉疱┅è卑磲脲礤翳镤蝈姝轭骘沆狍蟓钺礤钺礤豉疱┅è北磲脲轭翦蜴徙瀛礤翳镤蝈姝轭骘沆狍蟓钺礤钺礤豉疱┅┅┅è辈ㄤ弩趄蹉趱蜷铉忾钿钺礤轭溴豉疱轭溴蝈篝泔铙翎铘戾è钺礤豸娓ㄢ蹰熹泔铙翎铘痫镬钺礤轭溴┅豉疱豸娓ㄢ蹰熹泔铙翎铘痫镬豉疱轭溴┅磲脲钺礤犷洵豉疱轭骘豸娓轭骘翦钺礤豸娓豸娓轭骘翦豉疱豸娓┅┅è钡ㄤ弩趄蹉趱蜷铉忾钿腴钿蝈驽蝈钽濠蝈篝泔铙翎铘磲脲礤翳镤栳钿戾轭骘腴钿ㄢ蹰熹泔铙翎铘痫镬蝈驽蝈钽濠┅è狈备ㄤ弩趄蹉趱蜷铉忾钿ㄢ镲趔趄狃轭溴钺礤豉疱轭溴蝈篝泔铙翎铘戾舄è钺礤豉疱ㄢ蹰熹泔铙翎铘痫镬钺礤豉疱轭溴┅钺礤钺礤犷洵豉疱轭骘钺礤钺礤豉疱┅豉疱钺礤犷洵豉疱轭骘豉疱钺礤豉疱┅ㄩ翎狈磲脲澌钺黹悱轭骘怙雉篝蜥瓠轭溴钺礤豉疱磲脲轭鲲脲澌钺黹悱轭骘怙雉篝蜥瓠轭溴钺礤豉疱┅┅泔铙翎铘┅┅┅ㄤ彐躅疳蝮瀛泔铙翎铘痫镬ㄢ翦螬换泔铙翎铘狎杯轭溴邃廖翳箝轶盹蝈翳犷翳徙趱犰泔躅戾舄è箝ū疳蝮瀛醪怡翦螬┅痫镬磲脲狎蜥ǐ箝濠洪铋糸犰屐屙孱铋飑┅祜镳骘骝镯躔麸箝滹箦翩ㄡ蝈痫镬椹戾舄è泔铙翎铘ㄡ祆镢狒瀛泔铙翎铘怡翦螬翎ㄦ轵篝泔铙翎铘┅换轭泸屙孱殒祜铉矧滹踱戾麒孱矧翎旦翎订ㄩ钽椹泔铙翎铘┅换疳蝮溴疱钿孱汩弩祜镳骘骝镯躔麸箝滹ㄢ蹰熹泔铙翎铘痫镬椹痫镬┅